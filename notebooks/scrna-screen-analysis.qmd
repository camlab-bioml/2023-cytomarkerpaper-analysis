---
title: "Full single-cell analysis"
format: html
---

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(SingleCellExperiment)
  library(readxl)
  library(Nebulosa)
  library(ComplexHeatmap)
  library(here)
  library(singleCellTK)
  library(ggrepel)
  library(ggpubr)
})
```

```{r}
sce <- readRDS(here("data/sce_screen_subsample.rds"))
```

```{r}
reducedDim(sce,'UMAP') <- reducedDim(sce, 'seuratUMAP')
```



```{r}
plotUMAP(sce, colorBy = "Seurat_louvain_Resolution0.5")
```

```{r}

plot_density(sce, features = rownames(sce))
```
```{r}
scater::plotDots(sce, features = rownames(sce), group = "Seurat_louvain_Resolution0.5", center=TRUE, scale=TRUE)
```
```{r}
scater::plotDots(sce, features = rownames(sce), group = "Seurat_louvain_Resolution0.5", zlim = c(2, 5))
```

# Let's do a deep dive on something relatively easy - CD8 Ts

```{r}
sce_full <- readRDS(here("data/sce_screen_full.rds"))
```

```{r}
## Cluster 2 is CD8s

dfsc <- colData(sce_full) |> 
  as.data.frame() |> 
         select(expression = Nd148Di,
                cluster = predicted_label,
         target) |> 
  as_tibble() 

dfsc <- filter(dfsc, !is.na(target))

```

```{r}
dfsum <- group_by(dfsc, target, cluster) |> 
  summarize(expr_mean = mean(log1p(expression)),
            expr_sd = sd(log1p(expression))) |> 
  ungroup()
```

```{r}
dfcd8 <- filter(dfsum, cluster == "2")
ggplot(dfcd8, aes(x = expr_mean, y = expr_sd)) +
  geom_point() +
  geom_label_repel(aes(label = target), data = filter(dfcd8, expr_sd > 1)) +
  geom_label_repel(aes(label = target), data = filter(dfcd8, expr_sd < 0.5, expr_mean > 4)) +
  theme_pubclean() +
  labs(x = "Mean expression", y = "Variance expression",
       subtitle = "Marker variance within CD8 T cells")
  
```

```{r}
dfcd20 <- filter(dfsum, cluster == "7")
ggplot(dfcd20, aes(x = expr_mean, y = expr_sd)) +
  geom_point() +
  geom_label_repel(aes(label = target), data = filter(dfcd20, expr_sd > 1.4)) +
  geom_label_repel(aes(label = target), data = filter(dfcd20, expr_sd < 0.5, expr_mean > 4)) +
  theme_pubclean() +
  labs(x = "Mean expression", y = "Variance expression",
       subtitle = "Marker variance within B cells")
```




# Contrast this to scRNA-seq PBMC data




